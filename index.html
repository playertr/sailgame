<!doctype html>
<html lang="en">

<head>
    <title>windy.js integration example</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <!-- <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width"> -->
    <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@main/dist/en/v7.0.0/legacy/ol.css">
    <style type="text/css">
        html,
        body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
        }

        #map {
            width: 100%;
            height: 100%;
            position: relative;
            background: black;
        }

        div.fill {
            width: 100%;
            height: 100%;
        }

        #windyMap {
            position: absolute;
            width: 100%;
            height: 100%;
            z-index: 1;
            pointer-events: none;
        }

        #gameMap {
            position: absolute;
            width: 100%;
            height: 100%;
            z-index: 2;
            pointer-events: none;
        }

        .ol-control {
            z-index: 3;
        }
    </style>
</head>

<body>
    <div id="map" class="map">
        <canvas id="gameMap" class="fill"></canvas>
        <canvas id="windyMap" class="fill"></canvas>
        <div id="olMap" class="fill"></div>
    </div>
    <script src="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@main/dist/en/v7.0.0/legacy/ol.js"></script>
    <script src="src/windy.js" type="text/javascript"></script>
    <script type="text/javascript">

        // desired width and height in pixels
        function resizeCanvas(canvas, canvasWidth, canvasHeight) {
            var ctx = canvas.getContext('2d')
            if (window.devicePixelRatio > 1) {
                canvas.width = canvasWidth * window.devicePixelRatio;
                canvas.height = canvasHeight * window.devicePixelRatio;
                canvas.style.width = canvasWidth + "px";
                canvas.style.height = canvasHeight + "px";

                ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
            }
        }
        var windCanvas = document.getElementById('windyMap')

        const coastline = new ol.style.Style({
            stroke: new ol.style.Stroke({
                color: 'white',
                width: 1,
            }),
        });

        var map = new ol.Map({
            layers: [
                new ol.layer.VectorTile({
                    source: new ol.source.VectorTile({
                        format: new ol.format.MVT({ layerName: 'layer', layers: ['Coastline'] }),
                        url: 'https://basemaps.arcgis.com/v1/arcgis/rest/services/World_Basemap/VectorTileServer/tile/{z}/{y}/{x}.pbf',
                    }),
                    style: coastline
                })
            ],
            // interactions: new ol.interaction.defaults.defaults({
            //     dragRotate: false,
            //     doubleClickZoom: false,
            //     dragPan: false,
            //     pinchRotate: false,
            //     pinchZoom: false,
            //     dragZoom: false,
            //     dragAndDrop: false,
            //     keyboardPan: false,
            //     keyboardZoom: false,
            //     mouseWheelZoom: false,
            //     pointer: false,
            //     select: false
            // }),
            target: olMap,
            view: new ol.View({
                center: [0, 0],
                zoom: 1
            }),
            pixelRatio: window.pixelRatio
        });

        var windy;
        function refreshWindy() {
            if (!windy) {
                return;
            }

            windy.stop();

            var mapSize = map.getSize();
            var extent = map.getView().calculateExtent(mapSize);
            extent = ol.proj.transformExtent(extent, 'EPSG:3857', 'EPSG:4326')

            // Transform from longitude,latitude to screen coordinates.
            var project_cb = function (lon, lat) {
                return map.getPixelFromCoordinate(ol.proj.fromLonLat([lon, lat], 'EPSG:3857'))
            }

            resizeCanvas(windCanvas, mapSize[0], mapSize[1]);

            windy.start(
                project_cb,
                extent
            );
        }

        fetch('gfs.json').then(function (response) {
            return response.json();
        }).then(function (json) {
            windy = new Windy({ canvas: windCanvas, data: json}, );
            refreshWindy();
        });

        map.on('moveend', refreshWindy);

        // ctx = document.getElementById('gameMap').getContext("2d");

        // function draw() {
        //     var x = 0
        //     var y = 0

        //     //  Select the colour to fill the canvas
        //     ctx.fillStyle = "white"
        //     //  Select the colour for the border of the canvas
        //     ctx.strokestyle = "darkblue";

        //     // Draw a "filled" rectangle to cover the entire canvas
        //     ctx.fillRect(x, y, 50, 50);
        //     // Draw a "border" around the entire canvas
        //     ctx.strokeRect(x, y, 50, 50);

        //     console.log("Drew square.")
        // }

        // draw()

// document.addEventListener("keydown", keyDownEvent)

// function keyDownEvent(e) {
//     switch (e.keyCode) {
//       case 37:
//         nextX = -1;
//         nextY = 0;
//         break;
//       case 38:
//         nextX = 0;
//         nextY = -1;
//         break;
//       case 39:
//         nextX = 1;
//         nextY = 0;
//         break;
//       case 40:
//         nextX = 0;
//         nextY = 1;
//         break;
//       case 32:
//         if(gameActive == true) {
//             pauseGame();
//         }
//         else {
//             gameControl = startGame(x);
//         }
//         break;
//     }
// }


    </script>
</body>

</html>